# Implementation Plan: K3s Secret Encryption at Rest

**Branch**: `023-k3s-secret-encryption` | **Date**: 2025-12-27 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/023-k3s-secret-encryption/spec.md`

## Summary

Enable encryption at rest for Kubernetes secrets in the K3s cluster to address the security vulnerability where secrets stored in the embedded SQLite database are currently only base64 encoded (not encrypted). Implementation requires reinstalling K3s with the `--secrets-encryption` flag and re-encrypting all 112 existing secrets.

## Technical Context

**Language/Version**: Bash scripting (K3s CLI, kubectl)
**Primary Dependencies**: K3s v1.33.7+k3s1, kubectl
**Storage**: K3s embedded SQLite datastore (encrypted after implementation)
**Testing**: Manual validation scripts, k3s secrets-encrypt CLI
**Target Platform**: Ubuntu 24.04.3 LTS (server nodes)
**Project Type**: Infrastructure configuration (no application code)
**Performance Goals**: < 10ms additional latency for secret operations
**Constraints**: Zero application downtime, HA cluster coordination
**Scale/Scope**: 2 server nodes, 2 worker nodes, 112 existing secrets

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Infrastructure as Code | ✅ PASS | K3s config via CLI flags (documented) |
| II. GitOps Workflow | ✅ PASS | Feature branch workflow followed |
| V. Security Hardening | ✅ PASS | Core objective of this feature |
| VII. Test-Driven Learning | ✅ PASS | Validation script included |
| VIII. Documentation-First | ✅ PASS | Full documentation artifacts |
| IX. Network-First Security | ✅ N/A | No network changes required |

**Post-Phase 1 Re-check**: All gates pass. Encryption configuration aligns with security hardening principles.

## Project Structure

### Documentation (this feature)

```text
specs/023-k3s-secret-encryption/
├── spec.md              # Feature specification
├── plan.md              # This file
├── research.md          # Research findings
├── data-model.md        # Entity documentation
├── quickstart.md        # Implementation guide
├── contracts/
│   ├── encryption-config.yaml   # Configuration contract
│   └── validation-script.sh     # Verification script
├── checklists/
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # (Generated by /speckit.tasks)
```

### Server Node Changes

```text
/var/lib/rancher/k3s/server/
├── cred/
│   └── encryption-config.json   # NEW: Encryption configuration
├── db/
│   └── state.db                 # MODIFIED: Secrets now encrypted
└── token                        # UNCHANGED
```

**Structure Decision**: Infrastructure-only change. No application code. Changes are configuration on server nodes with documentation in this repository.

## Implementation Phases

### Phase 1: Pre-flight Validation

1. Verify SSH access to server nodes
2. Create backup of current secrets
3. Document current secret count (112)
4. Verify K3s version compatibility (v1.33.7 ✓)

### Phase 2: Enable Encryption

1. Reinstall K3s on master1 with `--secrets-encryption` flag
2. Verify encryption enabled via `k3s secrets-encrypt status`
3. Restart K3s on nodo03 to sync encryption config
4. Verify encryption hash matches on both servers

### Phase 3: Re-encrypt Existing Secrets

1. Run `k3s secrets-encrypt reencrypt` on master1
2. Monitor until stage shows `reencrypt_finished`
3. Verify all secrets accessible via kubectl

### Phase 4: Verification and Documentation

1. Run validation script on server nodes
2. Backup encryption-config.json to secure location
3. Update CLAUDE.md with encryption documentation
4. Close GitHub Issue #22

## Key Technical Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Encryption provider | aescbc | Default, production-proven, sufficient for homelab |
| Enable method | Reinstall with flag | Only supported method per K3s docs |
| Re-encryption timing | Immediate | 112 secrets ≈ 22 seconds |
| HA coordination | Sequential restart | Sync encryption hash between servers |

## Complexity Tracking

No complexity violations. Implementation follows standard K3s documentation without additional abstraction.

## Dependencies

- SSH access to 192.168.4.101 (master1), 192.168.4.103 (nodo03)
- Root/sudo privileges on server nodes
- kubectl access with cluster-admin privileges
- Backup storage for encryption configuration

## Risks

| Risk | Mitigation |
|------|------------|
| Encryption key loss | Backup encryption-config.json immediately after enable |
| K3s fails to start | Test on staging or have rollback plan ready |
| Brief API unavailability | Schedule during maintenance window |

## Artifacts Generated

- [x] `research.md` - Research findings and decisions
- [x] `data-model.md` - Entity documentation
- [x] `contracts/encryption-config.yaml` - Configuration schema
- [x] `contracts/validation-script.sh` - Verification script
- [x] `quickstart.md` - Step-by-step implementation guide
- [ ] `tasks.md` - (Next: run /speckit.tasks)
